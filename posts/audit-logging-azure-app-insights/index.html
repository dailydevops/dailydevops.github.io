<!doctype html><html class="no-js" lang="en" dir="ltr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#15a"><title>Audit Logging That Survives Your Next Security Incident — Daily DevOps & .NET</title><meta name="description" content="Your audit logs probably won&rsquo;t survive a real security incident. Most implementations log too much, protect too little, and provide zero value when …"><meta name="twitter:description" property="og:description" content="Your audit logs probably won&rsquo;t survive a real security incident. Most implementations log too much, protect too little, and provide zero value when …"><meta name="author" content="Martin Stühmer"><link rel="icon" href="/logo.svg?v=b9e294dc5c6fa04439c8c803d8e981a9" sizes="any" type="image/svg+xml"><meta name="twitter:title" property="og:title" content="Audit Logging That Survives Your Next Security Incident — Daily DevOps & .NET"><meta property="og:updated_time" content="2026-01-29T17:06:26+01:00"><meta property="article:modified_time" content="2026-01-29T17:06:26+01:00"><meta property="article:published_time" content="2026-01-29T17:00:00+01:00"><meta property="og:type" content="article"><meta property="og:site_name" content="Daily DevOps & .NET"><meta property="og:url" content="https://daily-devops.net/posts/audit-logging-azure-app-insights/"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary_large_image"><meta property="og:image" name="twitter:image" content="https://daily-devops.net/images/observability-1200x630.webp?v=70545a8a4a27caa2049032fc835df23f"><meta property="og:image:secure_url" content="https://daily-devops.net/images/observability-1200x630.webp?v=70545a8a4a27caa2049032fc835df23f"><meta property="og:image:alt" name="twitter:image:alt" content="Audit Logging That Survives Your Next Security Incident"><meta property="og:image:type" content="image/webp"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="og:image" name="twitter:image" content="https://daily-devops.net/images/observability-1200x630.png?v=2356dea6598e17c3812aad6794fbdb4f"><meta property="og:image:secure_url" content="https://daily-devops.net/images/observability-1200x630.png?v=2356dea6598e17c3812aad6794fbdb4f"><meta property="og:image:alt" name="twitter:image:alt" content="Audit Logging That Survives Your Next Security Incident"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><link rel="dns-prefetch" href="https://www.clarity.ms"><link rel="preconnect" href="https://www.clarity.ms" crossorigin><link rel="stylesheet" href="/css/style.min.0b2ef4378cd908eb695017aaa74603d244ff2b38c8068b4b51d76cad830c8ee5e3a40b67ab5b860a542c8bae73d8ba90cfbe9249b59c733a50de74cc32af818a.css" integrity="sha512-Cy70N4zZCOtpUBeqp0YD0kT/KzjIBotLUddsrYMMjuXjpAtnq1uGClQsi65z2LqQz76SSbWcczpQ3nTMMq+Big==" crossorigin="anonymous"><link rel="alternate" href='https://daily-devops.net/posts/audit-logging-azure-app-insights/' hreflang="x-default" title="Audit Logging That Survives Your Next Security Incident &mdash; Daily DevOps & .NET"><link rel="canonical" href="https://daily-devops.net/posts/audit-logging-azure-app-insights/" hreflang="en" title="Audit Logging That Survives Your Next Security Incident &mdash; Daily DevOps & .NET"><link rel="home" href="https://daily-devops.net/" hreflang="en" title="Daily DevOps & .NET"><link rel="prev" href="https://daily-devops.net/posts/cluster-upgrades-zero-downtime-aks/" hreflang="en" title="AKS Cluster Upgrades: Zero-Downtime Operations That Actually Work
"><link rel="author" href="https://daily-devops.net/authors/martin/" hreflang="en" title="Martin Stühmer &mdash; Daily DevOps & .NET"><meta name="giscus:backlink" content="https://daily-devops.net/posts/audit-logging-azure-app-insights/"><script defer src="/js/above.min.cb42b2c9a453e49e278326637d72d2f01e7f32e3f91e9cdde8fb587793d05514efd2f5cc5021c9658ca0f73876dbdcd1f7cb4a37c0bebc9df01110926b6d7cba.js" integrity="sha512-y0KyyaRT5J4ngyZjfXLS8B5/MuP5Hpzd6PtYd5PQVRTv0vXMUCHJZYyg9zh229zR98tKN8C+vJ3wERCSa218ug==" crossorigin="anonymous"></script><script type="text/javascript">(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","o0pr4n9gg3")</script><script src="https://analytics.ahrefs.com/analytics.js" data-key="C5Iv+2Rb9el+FLJqVw2QGA" async></script></head><body class="container"><header class="header"><a class="logo" href="/" title="Daily DevOps & .NET" rel="home"><figure class="page-logo"><picture><img src="/logo.svg?v=b9e294dc5c6fa04439c8c803d8e981a9" alt="Daily DevOps & .NET" title="Daily DevOps & .NET"></picture></figure><span class="title">Daily DevOps & .NET</span></a><nav class="menu" aria-label="Main navigation"><button class="burger" type="button" aria-haspopup="menu" aria-expanded="false" aria-label="Toggle menu">
<i class="fas fa-burger" aria-hidden="true"></i></button><ul class="navigation"><li class="active"><a href="/posts/">Posts</a></li><li><a href="/authors/">About us</a></li></ul></nav><div class="divider"></div></header><main class="body"><figure class="hero"><picture><source srcset="/images/observability-544x136.webp?v=5ef04bd948966214b6e82575ec5a775e" type="image/webp" media="(max-width: 575.98px)"><source srcset="/images/observability-544x136.png?v=387efa09641fb1a916f8fa38a22befd4" type="image/png" media="(max-width: 575.98px)"><source srcset="/images/observability-672x168.webp?v=a231b29a2bf664b7afbb476c48f3ccbf" type="image/webp" media="(max-width: 767.98px)"><source srcset="/images/observability-672x168.png?v=4f22340b42ca04e05c6eea2933ba725b" type="image/png" media="(max-width: 767.98px)"><source srcset="/images/observability-896x224.webp?v=41947c132b57f4aa5eb11add7190f042" type="image/webp" media="(max-width: 991.98px)"><source srcset="/images/observability-896x224.png?v=243e18dd82b3f8a7877eda0e5e66a07b" type="image/png" media="(max-width: 991.98px)"><source srcset="/images/observability-1104x276.webp?v=aa30902528a74c32331b5f8f3181a466" type="image/webp" media="(max-width: 1199.98px)"><source srcset="/images/observability-1104x276.png?v=992656b3921c66bf1e2a8a7dc695cd2a" type="image/png" media="(max-width: 1199.98px)"><source srcset="/images/observability-1444x361.webp?v=6af816fee2d8212f9b366a19d2973d2d" type="image/webp"><source srcset="/images/observability-1444x361.png?v=3c6141d2042c68b7567192800811bbd2" type="image/png"><img src="/images/observability.png?v=48acbd668436dc9dd3287b4ec5564639" alt="Audit Logging That Survives Your Next Security Incident" loading="lazy" decoding="async" title="Audit Logging That Survives Your Next Security Incident"></picture></figure><article class="post"><header><h1>Audit Logging That Survives Your Next Security Incident</h1></header><section class="content" role="region"><p>&ldquo;Show me the access logs for user authentication events over the past six months.&rdquo;</p><p>You grep through text files scattered across three servers, paste fragments into Excel, and spend forty minutes assembling evidence that proves nothing useful. The auditor checks a box. You both know this is theater.</p><p>This scene replays in organizations everywhere, and it reveals a fundamental misunderstanding about what audit logging should accomplish. Teams treat logging as a checkbox exercise—something to satisfy compliance requirements rather than infrastructure that actually protects systems and enables incident response.</p><p>ISO 27001 Control A.12.4 exists because security incidents leave traces—if you capture them. Attackers probing authentication endpoints, privilege escalations, unauthorized data exports—these events generate signals. The question is whether your logging infrastructure captures those signals in a form that&rsquo;s actually useful, or whether it buries them in terabytes of unstructured noise.</p><p>Most implementations fail spectacularly. They log too much, filling disks with DEBUG spam that nobody reads. They log too little, providing no context when something breaks at 2 AM. They log the wrong things—I&rsquo;ve reviewed codebases that captured credit card numbers and API keys in plain text while missing the authentication failures that would have detected an actual breach. And they store logs where application users can delete them, which defeats the entire purpose of audit trails.</p><p>The gap between &ldquo;we have logging&rdquo; and &ldquo;we satisfy A.12.4&rdquo; is wider than teams realize. This article closes it using .NET structured logging with Application Insights—not compliance theater, but infrastructure that engineers actually use for troubleshooting while simultaneously satisfying auditors.</p><h2 id="what-a124-actually-requires"><a href="/posts/audit-logging-azure-app-insights/#what-a124-actually-requires" title="What A.12.4 Actually Requires">What A.12.4 Actually Requires</a></h2><p>Four controls. Four things auditors check.</p><p><strong>A.12.4.1 (Event logging)</strong> mandates recording user activities, exceptions, and security events with sufficient context for investigation. When unauthorized access occurs, your logs must answer who did what, when, and where. Vague entries like &ldquo;error occurred&rdquo; provide zero forensic value.</p><p><strong>A.12.4.2 (Protection)</strong> addresses a reality that many teams ignore: attackers who compromise systems will attempt to cover their tracks. Logs stored in the same database that application users access? Non-compliant. Logs writable by the same service account that generates them? Equally problematic. You need immutable storage, separate credentials, and ideally external collection systems that the application itself cannot manipulate.</p><p><strong>A.12.4.3 (Privileged operations)</strong> recognizes that admin accounts represent elevated risk. When a database administrator exports the entire customer table at 3 AM, that event demands capture and review. Regular user activity might aggregate; privileged operations must remain granular and traceable.</p><p><strong>A.12.4.4 (Clock synchronization)</strong> sounds trivial until you try to reconstruct an incident timeline across distributed services. If your web tier timestamps events in UTC, your database in local time, and your authentication service in server time, correlation becomes guesswork. Consistent NTP synchronization isn&rsquo;t optional.</p><p>Meeting these requirements doesn&rsquo;t demand expensive SIEM products or complex compliance tools. It demands disciplined engineering.</p><h2 id="the-fatal-approach-what-fails-audits"><a href="/posts/audit-logging-azure-app-insights/#the-fatal-approach-what-fails-audits" title="The Fatal Approach: What Fails Audits">The Fatal Approach: What Fails Audits</a></h2><p>I&rsquo;ve reviewed codebases at three separate organizations over the past eighteen months that shared the same fundamental mistakes. The pattern is depressingly consistent:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;User {request.UserId} attempting order at {DateTime.Now}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Card {request.CreditCardNumber}, CVV {request.CVV}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Payment gateway key: {_config[&#34;</span><span class="n">PaymentGateway</span><span class="p">:</span><span class="n">ApiKey</span><span class="s">&#34;]}&#34;</span><span class="p">);</span>
</span></span></code></pre></div><p>This code violates every A.12.4 control simultaneously, and I&rsquo;m not exaggerating. The unstructured string concatenation produces logs that are impossible to query. When an auditor requests &ldquo;all access attempts by user ID 42,&rdquo; you hand them a 900 MB text file with instructions to Ctrl+F. That&rsquo;s not compliance—that&rsquo;s evidence of negligence.</p><p><code>Console.WriteLine</code> outputs vanish when containers restart. In production, you might retain three weeks of logs instead of six months because deployments rotate infrastructure. The auditor asks for historical data; you explain that it doesn&rsquo;t exist.</p><p>The sensitive data exposure creates immediate PCI-DSS violations alongside the A.12.4.2 failures. Credit card numbers, CVV codes, API keys—all logged in plain text, accessible to thirty developers who have read permissions for debugging purposes. When breach notification requirements trigger, these logs become evidence of negligent data handling.</p><p>Without correlation IDs, tracing a single request across distributed services becomes archaeology. The order creation endpoint calls inventory, payment, and notification services. Each generates independent log streams with no shared identifier. Good luck reconstructing what actually happened when something fails.</p><p>And <code>DateTime.Now</code> instead of UTC guarantees timestamp chaos. Your US-East servers log in EST, your Europe instances in CET, your database in UTC. Incident timelines become exercises in timezone arithmetic that auditors rightfully reject.</p><p>This approach fails audits, fails operations, and fails security. All at once.</p><h2 id="the-correct-approach-structured-logging"><a href="/posts/audit-logging-azure-app-insights/#the-correct-approach-structured-logging" title="The Correct Approach: Structured Logging">The Correct Approach: Structured Logging</a></h2><p>.NET&rsquo;s <code>ILogger</code> interface supports structured logging out of the box, yet most teams use it incorrectly. The critical pattern that separates queryable audit trails from unstructured noise: message templates with semantic properties instead of string interpolation.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">_logger</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">(</span><span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [&#34;CorrelationId&#34;]</span> <span class="p">=</span> <span class="n">Activity</span><span class="p">.</span><span class="n">Current</span><span class="p">?.</span><span class="n">Id</span> <span class="p">??</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">().</span><span class="n">ToString</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl"><span class="na">    [&#34;UserId&#34;]</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">UserId</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Order creation initiated for UserId {UserId} with Amount {Amount}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">request</span><span class="p">.</span><span class="n">UserId</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">TotalAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Processing payment, CardLast4 {CardLast4}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">MaskCreditCard</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">CreditCardNumber</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_logger</span><span class="p">.</span><span class="n">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#34;Order failed for UserId {UserId}&#34;</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">UserId</span><span class="p">);</span>
</span></span></code></pre></div><p>The difference between <code>$"User {userId}"</code> and <code>"User {UserId}", userId</code> seems cosmetic, but it&rsquo;s fundamental. The first produces opaque text that requires regex parsing. The second captures <code>UserId</code> as a structured property that Application Insights indexes automatically. You can query <code>traces | where customDimensions.UserId == "42"</code> and retrieve every operation for that user in seconds—no grep, no text parsing, no manual correlation.</p><p>Correlation IDs via <code>Activity.Current</code> propagate across distributed calls automatically. ASP.NET Core creates an <code>Activity</code> for each inbound request, and when you call downstream services using <code>HttpClient</code>, that ID flows via headers. Application Insights groups these distributed traces, visualizing the complete request flow across services. This is A.12.4.1 compliance that also makes production debugging possible.</p><p>Redaction of sensitive data prevents the credential exposure that plagues most codebases. The <code>MaskCreditCard</code> helper preserves last-four digits for support purposes while removing PAN data that triggers PCI-DSS scope. API keys, passwords, tokens—none appear in logs. You capture context without creating liability.</p><h3 id="application-insights-setup"><a href="/posts/audit-logging-azure-app-insights/#application-insights-setup" title="Application Insights Setup">Application Insights Setup</a></h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddApplicationInsightsTelemetry</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">options</span><span class="p">.</span><span class="n">ConnectionString</span> <span class="p">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#34;ApplicationInsights:ConnectionString&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">options</span><span class="p">.</span><span class="n">EnableAdaptiveSampling</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Compliance: retain ALL logs</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">builder</span><span class="p">.</span><span class="n">Logging</span><span class="p">.</span><span class="n">AddApplicationInsights</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">builder</span><span class="p">.</span><span class="n">Logging</span><span class="p">.</span><span class="n">SetMinimumLevel</span><span class="p">(</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">);</span>
</span></span></code></pre></div><p>Disabling adaptive sampling is non-negotiable for compliance. Sampling reduces costs by discarding a percentage of telemetry in high-volume scenarios, but it violates A.12.4.1&rsquo;s requirement for complete audit trails. Auditors don&rsquo;t accept &ldquo;we probably captured most authentication attempts.&rdquo; You need every event, or you need to implement server-side filtering based on severity and event type.</p><p>Setting the minimum log level to <code>Information</code> balances detail with noise. You capture business events—orders created, payments processed, authentication decisions—while excluding the DEBUG and TRACE spam that provides zero audit value. For privileged operations, use <code>LogWarning</code> to ensure they stand out during review.</p><h3 id="audit-middleware"><a href="/posts/audit-logging-azure-app-insights/#audit-middleware" title="Audit Middleware">Audit Middleware</a></h3><p>Capturing HTTP request/response cycles requires middleware that logs every inbound call with appropriate context. The pattern is straightforward but often implemented incorrectly:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">async</span> <span class="n">Task</span> <span class="n">InvokeAsync</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">using</span> <span class="nn">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">_logger</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">(</span><span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">        [&#34;CorrelationId&#34;]</span> <span class="p">=</span> <span class="n">Activity</span><span class="p">.</span><span class="n">Current</span><span class="p">?.</span><span class="n">Id</span> <span class="p">??</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">().</span><span class="n">ToString</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl"><span class="na">        [&#34;UserId&#34;]</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">User</span><span class="p">?.</span><span class="n">Identity</span><span class="p">?.</span><span class="n">Name</span> <span class="p">??</span> <span class="s">&#34;anonymous&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="na">        [&#34;IPAddress&#34;]</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Connection</span><span class="p">.</span><span class="n">RemoteIpAddress</span><span class="p">?.</span><span class="n">ToString</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl"><span class="na">        [&#34;RequestPath&#34;]</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Path</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">_logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">&#34;HTTP {Method} {Path} from {IPAddress}&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Method</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Path</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">Connection</span><span class="p">.</span><span class="n">RemoteIpAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="n">_next</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">level</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">&gt;=</span> <span class="m">400</span> <span class="p">?</span> <span class="n">LogLevel</span><span class="p">.</span><span class="n">Warning</span> <span class="p">:</span> <span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&#34;HTTP {Method} {Path} completed with {StatusCode}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Method</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This middleware captures user identity from the authenticated context, IP address for geographic correlation, request path for access pattern analysis, and response status for success/failure tracking. Logging at different levels based on outcome—<code>Information</code> for successful requests, <code>Warning</code> for 4xx client errors—enables alert rules that notify on elevated error rates without flooding dashboards with routine traffic.</p><h3 id="privileged-operations"><a href="/posts/audit-logging-azure-app-insights/#privileged-operations" title="Privileged Operations">Privileged Operations</a></h3><p>A.12.4.3 demands enhanced logging for administrative actions. Identify endpoints that modify configuration, grant permissions, or access sensitive data, then tag them explicitly:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="na">[Authorize(Roles = &#34;Administrator&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="n">GrantRole</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">RoleRequest</span> <span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_logger</span><span class="p">.</span><span class="n">LogWarning</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;PRIVILEGED: {AdminId} granting {Role} to {TargetId}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">User</span><span class="p">.</span><span class="n">FindFirstValue</span><span class="p">(</span><span class="n">ClaimTypes</span><span class="p">.</span><span class="n">NameIdentifier</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="p">.</span><span class="n">RoleName</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Using <code>LogWarning</code> for privileged operations ensures they appear in filtered views even when successful. The &ldquo;PRIVILEGED&rdquo; prefix enables trivial querying: <code>traces | where message startswith "PRIVILEGED"</code> retrieves every admin action across your entire infrastructure. When an incident investigation requires understanding what privileges were modified leading up to a breach, you have that answer in seconds.</p><h3 id="cicd-validation"><a href="/posts/audit-logging-azure-app-insights/#cicd-validation" title="CI/CD Validation">CI/CD Validation</a></h3><p>Catch logging regressions before production:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Validate no Console.WriteLine</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    if grep -r &#34;Console\.WriteLine&#34; src/ --include=&#34;*.cs&#34; --exclude-dir=Tests; then
</span></span></span><span class="line"><span class="cl"><span class="sd">      echo &#34;ERROR: Use ILogger, not Console.WriteLine&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">      exit 1
</span></span></span><span class="line"><span class="cl"><span class="sd">    fi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Check for credential logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    if grep -ri &#34;password\|apikey\|secret&#34; src/*.cs | grep -i &#34;log&#34;; then
</span></span></span><span class="line"><span class="cl"><span class="sd">      echo &#34;WARNING: Review for sensitive data in logs&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">    fi</span><span class="w">
</span></span></span></code></pre></div><h3 id="retention-and-access"><a href="/posts/audit-logging-azure-app-insights/#retention-and-access" title="Retention and Access">Retention and Access</a></h3><p>Application Insights stores telemetry in Azure Log Analytics workspaces, which provide built-in retention and access controls that satisfy A.12.4.2. Configure retention to match your compliance requirements—typically 90 days minimum, often 365 days for regulated industries. Navigate to your Log Analytics workspace, find Usage and estimated costs, and set Data Retention appropriately.</p><p>Role-based access control restricts who can query logs. Grant read access to security teams using Azure&rsquo;s &ldquo;Log Analytics Reader&rdquo; role. Developers troubleshooting production issues may need temporary access; implement time-bound role assignments via Azure Privileged Identity Management. The critical principle: developers who deploy code should not have unrestricted access to production logs containing user activity and authentication events.</p><p>Application Insights&rsquo; append-only storage model inherently satisfies immutability requirements. Once telemetry is ingested, it cannot be modified or deleted by application service principals. Only Azure administrators with workspace-level permissions can purge data, and those actions create audit logs in Azure Activity Log. Compromised application credentials cannot erase evidence.</p><h2 id="compliance-queries-kql"><a href="/posts/audit-logging-azure-app-insights/#compliance-queries-kql" title="Compliance Queries (KQL)">Compliance Queries (KQL)</a></h2><p>Auditor evidence in seconds:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">// All auth attempts for user 42
</span></span><span class="line"><span class="cl">traces | where customDimensions.UserId == &#34;42&#34; 
</span></span><span class="line"><span class="cl">       | where message contains &#34;login&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Privileged operations
</span></span><span class="line"><span class="cl">traces | where message startswith &#34;PRIVILEGED&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Failed requests over time  
</span></span><span class="line"><span class="cl">requests | where resultCode &gt;= 400 | summarize count() by bin(timestamp, 1h)
</span></span></code></pre></div><p>Export to CSV. Done.</p><h2 id="beyond-compliance"><a href="/posts/audit-logging-azure-app-insights/#beyond-compliance" title="Beyond Compliance">Beyond Compliance</a></h2><p>Teams that implement structured logging for compliance invariably discover benefits that extend far beyond satisfying auditors.</p><p>When production breaks at 2 AM, correlation IDs trace requests across distributed services in seconds. No manual log aggregation, no timezone conversion, no guessing which error corresponds to which user session. Application Insights distributed tracing visualizes the failure path, and you fix the root cause instead of treating symptoms.</p><p>Application Insights Smart Detection analyzes telemetry patterns and alerts on deviations—sudden increases in authentication failures that might indicate credential stuffing, spikes in 500 errors following deployments, elevated response times suggesting database contention. These signals emerge from structured logs; you can&rsquo;t detect anomalies in unstructured text.</p><p>One team I worked with discovered that 40% of their Azure SQL DTU consumption came from a single inefficient query—identified via structured logging of database operation timings. The logging infrastructure they built for compliance paid for itself in reduced cloud spend within three months.</p><p>And beyond ISO 27001, the same structured audit logs satisfy requirements from GDPR Article 30, SOC 2 CC7.2, and PCI-DSS Requirement 10. Build the infrastructure once, satisfy multiple regulatory frameworks.</p><blockquote><p>Build observability that happens to satisfy compliance—not compliance theater that happens to generate logs.</p></blockquote><h2 id="getting-started"><a href="/posts/audit-logging-azure-app-insights/#getting-started" title="Getting Started">Getting Started</a></h2><p>If your current logging consists of <code>Console.WriteLine</code> scattered throughout controllers, the path forward is straightforward. Add the <code>Microsoft.ApplicationInsights.AspNetCore</code> NuGet package and configure the connection string. Replace string interpolation with message templates—convert <code>$"User {userId}"</code> to <code>"User {UserId}", userId</code> so properties become queryable.</p><p>Implement correlation IDs via <code>Activity.Current</code> in request scopes, ensuring every log statement within a request shares the same identifier. Grep your codebase for <code>password</code>, <code>apikey</code>, <code>secret</code>, and <code>token</code> in logging statements. If you find matches, you have work to do before your next audit.</p><p>Add audit middleware for HTTP request/response cycles. Configure Log Analytics retention appropriate to your industry. Verify that application service principals cannot delete telemetry data. Write the KQL queries your auditors will request and test them with your security team before the audit arrives.</p><p>A.12.4 doesn&rsquo;t require expensive SIEMs or complex third-party compliance tools. It requires disciplined engineering: structured properties, protected storage, correlation across distributed systems, and consistent UTC timestamps. .NET&rsquo;s <code>ILogger</code> and Azure Application Insights provide these capabilities natively. The effort lies not in adopting new tools, but in applying existing tools correctly.</p><p>Your auditor checks a box. Your on-call engineers thank you at 2 AM. Your security team has visibility that actually matters when incidents occur.</p><p>That&rsquo;s compliance done right.</p></section><section class="giscus"><h2>Comments</h2><aside class="giscus" id="giscus-thread" role="region" aria-label="Comments"></aside></section><script src="https://giscus.app/client.js" data-repo="dailydevops/dailydevops.github.io" data-repo-id="R_kgDOHA8eFg" data-category="Announcements" data-category-id="DIC_kwDOHA8eFs4COIqL" data-mapping="pathname" data-strict="1" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous" async></script></article><aside class="sidebar divider"><section class="sidecar info" aria-labelledby="info-heading"><header><h2 id="info-heading" class="sr-only">Informations</h2></header><ul role="list"><li role="listitem"><time datetime="2026-01-29T17:00:00+01:00" itemprop="datePublished">Published on 1/29/26 5:00 pm</time></li><li>Read in 10 minutes</li></ul></section><section class="sidecar series" aria-labelledby="series-heading"><header><h2 id="series-heading">Series content</h2></header><nav class="series-nav" role="navigation" aria-label="Series content"><ul role="list"><li role="listitem"><a href="https://daily-devops.net/posts/iso-standards-intro-dotnet-developers/" title="Why ISO Standards Actually Matter for .NET Developers" target="_blank" rel="noopener external noreferrer"><i class="fas fa-angles-right" aria-hidden="true"></i>&nbsp;
Why ISO Standards Actually Matter for .NET Developers</a></li><li role="listitem"><a href="https://daily-devops.net/posts/access-control-aspnet-core/" title="Your [Authorize] Attribute Is Compliance Theater
" target="_blank" rel="noopener external noreferrer"><i class="fas fa-angles-right" aria-hidden="true"></i>&nbsp;
Your [Authorize] Attribute Is Compliance Theater</a></li><li role="listitem"><a href="https://daily-devops.net/posts/audit-logging-azure-app-insights/" title="Audit Logging That Survives Your Next Security Incident" target="_blank" rel="noopener external noreferrer"><i class="fas fa-angles-right" aria-hidden="true"></i>&nbsp;
Audit Logging That Survives Your Next Security Incident</a></li></ul></nav></section><section class="sidecar author" aria-labelledby="author-martin-st%C3%BChmer"><header><h2 id="author-martin-st%C3%BChmer"><a href="/authors/martin/" rel="author" title="Martin Stühmer" itemprop="url">Author <span itemprop="name">Martin Stühmer</span></a></h2></header><figure class="round"><picture><img src="https://www.gravatar.com/avatar/6da4a47ff9cc2b750452225fdb2582f7?d=identicon&amp;s=200" alt="Martin Stühmer" loading="lazy" decoding="async" title="Martin Stühmer"></picture></figure><section class="content" itemprop="description">CTO at Integrated Worlds building cloud-native solutions on Azure with modern .NET. Nearly 20 years in .NET from Framework 2.0 to today. Microsoft Certified Trainer, former CGI Director, open-source maintainer. I’ve made every mistake, bet on dead technologies, and learned more from failures than successes. Quality isn’t optional, buzzwords don’t ship features, and experience means knowing what to avoid.</section><a class="link" href="/authors/martin/" rel="author" aria-label="Author Martin Stühmer: Read more"></a></section><section class="sidecar social" aria-labelledby="social-heading"><header><h2 id="social-heading">Social media</h2></header><nav class="social-nav" role="navigation" aria-label="Social media links"><a class="icon bluesky" href="https://bsky.app/profile/samtrion.net" rel="noopener external" aria-label="Follow me on Bluesky" target="_blank"><span class="fa-stack fa-fw fa-1x" aria-hidden="true"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-bluesky fa-stack-1x fa-inverse"></i>
</span></a><a class="icon github" href="https://github.com/samtrion" rel="noopener external" aria-label="Follow me on GitHub" target="_blank"><i class="fa-brands fa-fw fa-github fa-2x" aria-hidden="true"></i></a>
<a class="icon linkedin" href="https://www.linkedin.com/in/martin-stuehmer" rel="noopener external" aria-label="Follow me on LinkedIn" target="_blank"><span class="fa-stack fa-fw fa-1x" aria-hidden="true"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin-in fa-stack-1x fa-inverse"></i>
</span></a><a class="icon stackoverflow" href="https://stackoverflow.com/users/10574963" rel="noopener external" aria-label="Follow me on Stack Overflow" target="_blank"><span class="fa-stack fa-fw fa-1x" aria-hidden="true"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
</span></a><a class="icon mail" href="mailto:martin@daily-devops.net" aria-label="Contact me by e-mail" target="_blank"><span class="fa-stack fa-fw fa-1x" aria-hidden="true"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
</span></a><a class="icon feed" href="/authors/martin/feed.rss" aria-label="My RSS feed" target="_blank"><span class="fa-stack fa-fw fa-1x" aria-hidden="true"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></nav></section><section class="sidecar share" aria-labelledby="share-heading"><header><h2 id="share-heading">Share this content</h2></header><a class="icon linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fdaily-devops.net%2fposts%2faudit-logging-azure-app-insights%2f&text=Audit%20Logging%20That%20Survives%20Your%20Next%20Security%20Incident%20%26mdash%3b%20Daily%20DevOps%20%26%20.NET" target="_blank" rel="noopener external" aria-label="Share on LinkedIn" title="Share on LinkedIn" target="_blank"><i class="fa-brands fa-fw fa-linkedin-in fa-2x"></i></a>
<a class="icon bluesky" href="https://bsky.app/intent/compose?text=Audit%20Logging%20That%20Survives%20Your%20Next%20Security%20Incident%20%26mdash%3b%20Daily%20DevOps%20%26%20.NET%20https%3a%2f%2fdaily-devops.net%2fposts%2faudit-logging-azure-app-insights%2f" target="_blank" rel="noopener external" aria-label="Share on Bluesky" title="Share on Bluesky" target="_blank"><i class="fa-brands fa-fw fa-bluesky fa-2x"></i></a></section><section class="sidecar tags" aria-labelledby="tags-heading"><header><h2 id="tags-heading">Tags</h2></header><ul class="tags" role="list"><li class="tag" role="listitem"><a href="/tags/dotnet/" hreflang="en" rel="tag" title=".NET" aria-label=".NET tag"><i class="fas fa-tag" aria-hidden="true"></i>&nbsp;.NET</a></li><li class="tag" role="listitem"><a href="/tags/azure/" hreflang="en" rel="tag" title="Azure" aria-label="Azure tag"><i class="fas fa-tag" aria-hidden="true"></i>&nbsp;Azure</a></li><li class="tag" role="listitem"><a href="/tags/bestpractices/" hreflang="en" rel="tag" title="Best Practices" aria-label="Best Practices tag"><i class="fas fa-tag" aria-hidden="true"></i>&nbsp;Best Practices</a></li><li class="tag" role="listitem"><a href="/tags/compliance/" hreflang="en" rel="tag" title="Compliance" aria-label="Compliance tag"><i class="fas fa-tag" aria-hidden="true"></i>&nbsp;Compliance</a></li><li class="tag" role="listitem"><a href="/tags/iso-standards/" hreflang="en" rel="tag" title="ISO Standards" aria-label="ISO Standards tag"><i class="fas fa-tag" aria-hidden="true"></i>&nbsp;ISO Standards</a></li><li class="tag" role="listitem"><a href="/tags/logging/" hreflang="en" rel="tag" title="Logging" aria-label="Logging tag"><i class="fas fa-tag" aria-hidden="true"></i>&nbsp;Logging</a></li><li class="tag" role="listitem"><a href="/tags/observability/" hreflang="en" rel="tag" title="Observability" aria-label="Observability tag"><i class="fas fa-tag" aria-hidden="true"></i>&nbsp;Observability</a></li><li class="tag" role="listitem"><a href="/tags/security/" hreflang="en" rel="tag" title="Security" aria-label="Security tag"><i class="fas fa-tag" aria-hidden="true"></i>&nbsp;Security</a></li></ul></section><section class="sidecar related" aria-labelledby="related-heading"><header><h2 id="related-heading">Related content</h2></header><article class="post"><figure class="square"><picture><source srcset="/images/security-80x80.webp?v=35f82cde59317b992b40db6eee90c415" type="image/webp"><source srcset="/images/security-80x80.png?v=6b7b9203a90fa2d6df665509ee32b1e2" type="image/png"><img src="/images/security.png?v=530c4f0b5995d08df3450423fd03c5e0" alt="Your [Authorize] Attribute Is Compliance Theater
" loading="lazy" decoding="async" title="Your [Authorize] Attribute Is Compliance Theater
"></picture></figure><header><h2><a href="/posts/access-control-aspnet-core/" rel="bookmark">Your [Authorize] Attribute Is Compliance Theater</a></h2></header><section class="content" role="region"><p><strong>Your <code>[Authorize]</code> attributes give you a false sense of security. ISO 27001 auditors see right through it.</strong></p><p>I&rsquo;ve reviewed dozens of ASP.NET Core apps that authenticate flawlessly — then scatter role strings across business logic, skip audit logs, and wonder why they fail compliance. Here&rsquo;s the pattern that kills audits, and how to actually fix it.</p></section></article><article class="post"><figure class="square"><picture><source srcset="/images/security-80x80.webp?v=35f82cde59317b992b40db6eee90c415" type="image/webp"><source srcset="/images/security-80x80.png?v=6b7b9203a90fa2d6df665509ee32b1e2" type="image/png"><img src="/images/security.png?v=530c4f0b5995d08df3450423fd03c5e0" alt="Why ISO Standards Actually Matter for .NET Developers" loading="lazy" decoding="async" title="Why ISO Standards Actually Matter for .NET Developers"></picture></figure><header><h2><a href="/posts/iso-standards-intro-dotnet-developers/" rel="bookmark">Why ISO Standards Actually Matter for .NET Developers</a></h2></header><section class="content" role="region">Cloud-native .NET development has transformed ISO/IEC 27001, 27017, and 27701 from abstract compliance requirements into concrete daily coding decisions. This guide shows .NET developers how security standards directly map to Azure Key Vault integration, Azure AD authentication, and proper logging—with real code examples demonstrating compliant vs. non-compliant implementations.</section></article><article class="post"><figure class="square"><picture><source srcset="/images/observability-80x80.webp?v=e029eb3d74e4d67f04990ad14af8ed68" type="image/webp"><source srcset="/images/observability-80x80.png?v=53f54ab518d5253040a9c4eff2a6b8ff" type="image/png"><img src="/images/observability.png?v=48acbd668436dc9dd3287b4ec5564639" alt="Why Your Logging Strategy Fails in Production" loading="lazy" decoding="async" title="Why Your Logging Strategy Fails in Production"></picture></figure><header><h2><a href="/posts/dotnet-advanced-logging/" rel="bookmark">Why Your Logging Strategy Fails in Production</a></h2></header><section class="content" role="region"><p>Let me tell you what I&rsquo;ve learned over the years from watching teams deploy logging strategies that looked great on paper and failed spectacularly at 3 AM when production burned.</p><p>It&rsquo;s not that they didn&rsquo;t know the theory. They&rsquo;d read the Azure documentation. They&rsquo;d seen the structured logging samples. They&rsquo;d studied distributed tracing. The real problem was different: they knew <em>what</em> to do but had no idea <em>why</em> it mattered until production broke catastrophically.</p></section></article></section></aside><nav class="pager" aria-label="Article navigation" role="navigation"><a class="prev" href="/posts/cluster-upgrades-zero-downtime-aks/" rel="prev" aria-label="Previous: AKS Cluster Upgrades: Zero-Downtime Operations That Actually Work
"><span class="sub"><span class="sr-only">Previous</span>&emsp;<i class="fas fa-forward" aria-hidden="true"></i></span><p class="title">AKS Cluster Upgrades: Zero-Downtime Operations That Actually Work</p></a></nav></main><footer class="footer"><div class="divider"></div><nav><ul class="navigation"><li><a href="/tags/">Tags</a></li><li><a href="/legal-notice/">Legal notice</a></li></ul></nav><div class="copyright">&copy; 2023 - 2026 Daily DevOps & .NET</div></footer><script defer src="/js/below.min.a6ce9164454b6077f17ae856f280442d9f3a1e21f06189f71c21f75144b22a0c8cf32bafd61d440e9d90ca02bf738b6a8ef19f5ec20285d8ca574f98c91ebaf2.js" integrity="sha512-ps6RZEVLYHfxeuhW8oBELZ86HiHwYYn3HCH3UUSyKgyM8yuv1h1EDp2QygK/c4tqjvGfXsIChdjKV0+YyR668g==" crossorigin="anonymous"></script><img class="vgwort" src="https://vg05.met.vgwort.de/na/98499d2485f34117a72dcf79f602338f" width="1" height="1" alt="VG Wort" title="VG Wort"></body></html>