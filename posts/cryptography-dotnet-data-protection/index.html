<!doctype html><html class="no-js" lang="en" dir="ltr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#15a"><title>Your Encryption Is Broken — .NET Data Protection Done Right — Daily DevOps & .NET</title><meta name="description" content="Every developer who has tried simple encryption with XOR and hardcoded keys eventually faces the audit that exposes their house of cards.
I&rsquo;ve …"><meta name="twitter:description" property="og:description" content="Every developer who has tried simple encryption with XOR and hardcoded keys eventually faces the audit that exposes their house of cards.
I&rsquo;ve …"><meta name="author" content="Martin Stühmer"><link rel="icon" href="/logo.svg?v=b9e294dc5c6fa04439c8c803d8e981a9" sizes="any" type="image/svg+xml"><meta name="twitter:title" property="og:title" content="Your Encryption Is Broken — .NET Data Protection Done Right — Daily DevOps & .NET"><meta property="og:updated_time" content="2026-02-05T17:06:04+01:00"><meta property="article:modified_time" content="2026-02-05T17:06:04+01:00"><meta property="article:published_time" content="2026-02-05T17:00:00+01:00"><meta property="og:type" content="article"><meta property="og:site_name" content="Daily DevOps & .NET"><meta property="og:url" content="https://daily-devops.net/posts/cryptography-dotnet-data-protection/"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary_large_image"><meta property="og:image" name="twitter:image" content="https://daily-devops.net/images/security-1200x630.webp?v=23a02c90b4722e133963cc7c0a010b71"><meta property="og:image:secure_url" content="https://daily-devops.net/images/security-1200x630.webp?v=23a02c90b4722e133963cc7c0a010b71"><meta property="og:image:alt" name="twitter:image:alt" content="Your Encryption Is Broken — .NET Data Protection Done Right"><meta property="og:image:type" content="image/webp"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="og:image" name="twitter:image" content="https://daily-devops.net/images/security-1200x630.png?v=c25b02c29e701934a389f13185e3526a"><meta property="og:image:secure_url" content="https://daily-devops.net/images/security-1200x630.png?v=c25b02c29e701934a389f13185e3526a"><meta property="og:image:alt" name="twitter:image:alt" content="Your Encryption Is Broken — .NET Data Protection Done Right"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><link rel="dns-prefetch" href="https://www.clarity.ms"><link rel="preconnect" href="https://www.clarity.ms" crossorigin><link rel="stylesheet" href="/css/style.min.0b2ef4378cd908eb695017aaa74603d244ff2b38c8068b4b51d76cad830c8ee5e3a40b67ab5b860a542c8bae73d8ba90cfbe9249b59c733a50de74cc32af818a.css" integrity="sha512-Cy70N4zZCOtpUBeqp0YD0kT/KzjIBotLUddsrYMMjuXjpAtnq1uGClQsi65z2LqQz76SSbWcczpQ3nTMMq+Big==" crossorigin="anonymous"><link rel="alternate" href='https://daily-devops.net/posts/cryptography-dotnet-data-protection/' hreflang="x-default" title="Your Encryption Is Broken — .NET Data Protection Done Right &mdash; Daily DevOps & .NET"><link rel="canonical" href="https://daily-devops.net/posts/cryptography-dotnet-data-protection/" hreflang="en" title="Your Encryption Is Broken — .NET Data Protection Done Right &mdash; Daily DevOps & .NET"><link rel="home" href="https://daily-devops.net/" hreflang="en" title="Daily DevOps & .NET"><link rel="prev" href="https://daily-devops.net/posts/storage-architecture-stateful-workloads-aks/" hreflang="en" title="Storage Architecture & Stateful Workloads in AKS"><link rel="author" href="https://daily-devops.net/authors/martin/" hreflang="en" title="Martin Stühmer &mdash; Daily DevOps & .NET"><meta name="giscus:backlink" content="https://daily-devops.net/posts/cryptography-dotnet-data-protection/"><script defer src="/js/above.min.cb42b2c9a453e49e278326637d72d2f01e7f32e3f91e9cdde8fb587793d05514efd2f5cc5021c9658ca0f73876dbdcd1f7cb4a37c0bebc9df01110926b6d7cba.js" integrity="sha512-y0KyyaRT5J4ngyZjfXLS8B5/MuP5Hpzd6PtYd5PQVRTv0vXMUCHJZYyg9zh229zR98tKN8C+vJ3wERCSa218ug==" crossorigin="anonymous"></script><script type="text/javascript">(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","o0pr4n9gg3")</script><script src="https://analytics.ahrefs.com/analytics.js" data-key="C5Iv+2Rb9el+FLJqVw2QGA" async></script></head><body class="container"><header class="header"><a class="logo" href="/" title="Daily DevOps & .NET" rel="home"><figure class="page-logo"><picture><img src="/logo.svg?v=b9e294dc5c6fa04439c8c803d8e981a9" alt="Daily DevOps & .NET" title="Daily DevOps & .NET"></picture></figure><span class="title">Daily DevOps & .NET</span></a><nav class="menu" aria-label="Main navigation"><button class="burger" type="button" aria-haspopup="menu" aria-expanded="false" aria-label="Toggle menu">
<i class="fas fa-burger" aria-hidden="true"></i></button><ul class="navigation"><li class="active"><a href="/posts/">Posts</a></li><li><a href="/authors/">About us</a></li></ul></nav><div class="divider"></div></header><main class="body"><figure class="hero"><picture><source srcset="/images/security-544x136.webp?v=bfca7afe6fd8a89b9abc2e6578377ecd" type="image/webp" media="(max-width: 575.98px)"><source srcset="/images/security-544x136.png?v=a11669f57e90374669cb0babb25f5dbd" type="image/png" media="(max-width: 575.98px)"><source srcset="/images/security-672x168.webp?v=62a10e076f01e08d890102aa4e02ef93" type="image/webp" media="(max-width: 767.98px)"><source srcset="/images/security-672x168.png?v=663fb88cff6268534d435ce8ba0b3ee0" type="image/png" media="(max-width: 767.98px)"><source srcset="/images/security-896x224.webp?v=7d4031888869a0df21996cf3fa43c47e" type="image/webp" media="(max-width: 991.98px)"><source srcset="/images/security-896x224.png?v=1d4fafee73dde51bc042c4b668d3c0e7" type="image/png" media="(max-width: 991.98px)"><source srcset="/images/security-1104x276.webp?v=e674c46b67ccbd2bb5466b95f11f41f6" type="image/webp" media="(max-width: 1199.98px)"><source srcset="/images/security-1104x276.png?v=4c7fb78837d783fc30f62e069d44945f" type="image/png" media="(max-width: 1199.98px)"><source srcset="/images/security-1444x361.webp?v=eb0adef2553eb5c47b56f0ed044eacd0" type="image/webp"><source srcset="/images/security-1444x361.png?v=1338349ed2f41119c662cbd6151058f9" type="image/png"><img src="/images/security.png?v=530c4f0b5995d08df3450423fd03c5e0" alt="Your Encryption Is Broken — .NET Data Protection Done Right" loading="lazy" decoding="async" title="Your Encryption Is Broken — .NET Data Protection Done Right"></picture></figure><article class="post"><header><h1>Your Encryption Is Broken — .NET Data Protection Done Right</h1></header><section class="content" role="region"><p>Every developer who has attempted <em>simple encryption</em> with <code>Encoding.UTF8.GetBytes()</code> and XOR operations eventually learns why <strong>cryptography is a specialization, not a feature sprint</strong>. Decades of spectacular failures proved that security through obscurity fails, hardcoded keys leak, and MD5 hashing passwords invites credential stuffing attacks. ISO/IEC 27001 exists because of these lessons—the standard demands policy-driven cryptographic controls and proper key management. Requirements that .NET&rsquo;s Data Protection API satisfies, if developers abandon the illusion that they can implement encryption better than Microsoft&rsquo;s cryptography team.</p><p>This isn&rsquo;t theoretical compliance. The cryptographic controls apply directly to .NET applications storing personally identifiable information (PII), authentication tokens, or any data requiring confidentiality. <a href="https://www.iso.org/standard/27001" target="_blank" rel="noopener external noreferrer">ISO 27001:2022</a> Annex A consolidates cryptographic requirements under <strong>A.8.24</strong> (Use of cryptography) with supporting controls for key management. The engineering decisions remain identical: encryption libraries, key storage infrastructure, and rotation schedules. Cloud-native .NET applications deployed to Azure must integrate these controls into their architecture, not bolt them on during audit preparation.</p><h2 id="the-fatal-pattern-homegrown-cryptography"><a href="/posts/cryptography-dotnet-data-protection/#the-fatal-pattern-homegrown-cryptography" title="The Fatal Pattern: Homegrown Cryptography">The Fatal Pattern: Homegrown Cryptography</a></h2><p>Before examining the correct implementation, let&rsquo;s dissect the recurring anti-pattern that violates ISO 27001 and creates exploitable vulnerabilities. This example synthesizes patterns observed in production codebases during security audits—systems that passed initial deployment reviews but failed compliance assessments.</p><h3 id="the-secure-encryption-class"><a href="/posts/cryptography-dotnet-data-protection/#the-secure-encryption-class" title="The &ldquo;Secure&rdquo; Encryption Class">The &ldquo;Secure&rdquo; Encryption Class</a></h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">DataEncryption</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// &#34;Nobody will find the key in the compiled assembly&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">const</span> <span class="kt">string</span> <span class="n">EncryptionKey</span> <span class="p">=</span> <span class="s">&#34;MyS3cr3tK3y!2024&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">Encrypt</span><span class="p">(</span><span class="kt">string</span> <span class="n">plainText</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">plainBytes</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">plainText</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">keyBytes</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">EncryptionKey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">encryptedBytes</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">plainBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">plainBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">            <span class="n">encryptedBytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="n">plainBytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">^</span> <span class="n">keyBytes</span><span class="p">[</span><span class="n">i</span> <span class="p">%</span> <span class="n">keyBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ToBase64String</span><span class="p">(</span><span class="n">encryptedBytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Password &#34;hashing&#34; with MD5</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">UserAuthentication</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">HashPassword</span><span class="p">(</span><span class="kt">string</span> <span class="n">password</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">using</span> <span class="nn">var</span> <span class="n">md5</span> <span class="p">=</span> <span class="n">MD5</span><span class="p">.</span><span class="n">Create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">hashBytes</span> <span class="p">=</span> <span class="n">md5</span><span class="p">.</span><span class="n">ComputeHash</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">password</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">BitConverter</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="n">hashBytes</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s">&#34;-&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">).</span><span class="n">ToLower</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="why-this-fails-iso-270012022-control-a824"><a href="/posts/cryptography-dotnet-data-protection/#why-this-fails-iso-270012022-control-a824" title="Why This Fails ISO 27001:2022 Control A.8.24">Why This Fails ISO 27001:2022 Control A.8.24</a></h3><p>This implementation violates multiple cryptographic principles and ISO requirements:</p><ol><li><p><strong>XOR is not encryption</strong> — Simple XOR operations provide zero cryptographic strength. The pattern is reversible through frequency analysis, and identical plaintext produces identical ciphertext, exposing data patterns.</p></li><li><p><strong>Hardcoded keys violate A.8.24</strong> — The key is embedded in source code, compiled into assemblies, and trivially extractable using tools like <a href="https://github.com/icsharpcode/ILSpy" target="_blank" rel="noopener external noreferrer">ILSpy</a> or dnSpy. ISO 27001:2022 requires secure key generation, storage, and lifecycle management.</p></li><li><p><strong>No initialization vector (IV)</strong> — The same plaintext always encrypts to the same ciphertext, enabling pattern recognition attacks. Professional encryption algorithms use random IVs to ensure semantic security.</p></li><li><p><strong>MD5 is cryptographically broken</strong> — The MD5 hashing algorithm has been deprecated since 2004 due to collision vulnerabilities. Password hashes require computationally expensive algorithms like bcrypt or Argon2 to resist brute-force attacks.</p></li><li><p><strong>No key rotation mechanism</strong> — The system has no provision for updating encryption keys without re-encrypting the entire database. ISO 27001 mandates key lifecycle management, including rotation schedules.</p></li><li><p><strong>Plain text storage assumption</strong> — The underlying belief—<em>the database is secure, so encryption is optional</em>—contradicts defense-in-depth principles. ISO 27001:2022 Control A.8.24 requires cryptographic controls specifically to protect data at rest.</p></li></ol><p>Audit failures from this pattern include <strong>GDPR violations</strong> (personal data inadequately protected), <strong>PCI-DSS non-compliance</strong> (cardholder data exposure), and <strong>ISO 27001 control deficiencies</strong>. The financial consequences range from regulatory fines to breach notification costs when the inevitable compromise occurs.</p><h2 id="the-correct-implementation-net-data-protection-api"><a href="/posts/cryptography-dotnet-data-protection/#the-correct-implementation-net-data-protection-api" title="The Correct Implementation: .NET Data Protection API">The Correct Implementation: .NET Data Protection API</a></h2><p>The <a href="https://learn.microsoft.com/aspnet/core/security/data-protection/introduction" target="_blank" rel="noopener external noreferrer">.NET Data Protection API</a> provides a purpose-built framework for protecting data at rest with proper key management, algorithm selection, and integration with Azure Key Vault. Unlike the homegrown approach, it abstracts cryptographic complexity while enforcing security best practices.</p><h3 id="configuration-with-azure-key-vault"><a href="/posts/cryptography-dotnet-data-protection/#configuration-with-azure-key-vault" title="Configuration with Azure Key Vault">Configuration with Azure Key Vault</a></h3><p>First, configure the Data Protection stack with <a href="https://learn.microsoft.com/azure/key-vault/general/overview" target="_blank" rel="noopener external noreferrer">Azure Key Vault</a> for key storage, satisfying external key management requirements:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="n">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Configure Data Protection with Azure Key Vault</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddDataProtection</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">SetApplicationName</span><span class="p">(</span><span class="s">&#34;customer-management-api&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">PersistKeysToAzureBlobStorage</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="s">&#34;https://yourstorageaccount.blob.core.windows.net/dataprotection-keys/keys.xml&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">ProtectKeysWithAzureKeyVault</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="s">&#34;https://yourkeyvault.vault.azure.net/keys/dataprotection&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">DefaultAzureCredential</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">SetDefaultKeyLifetime</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromDays</span><span class="p">(</span><span class="m">90</span><span class="p">));</span> <span class="c1">// Key rotation every 90 days</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This configuration establishes several critical controls. <strong>Key Storage</strong> ensures cryptographic keys persist in <a href="https://learn.microsoft.com/azure/storage/blobs/storage-blobs-introduction" target="_blank" rel="noopener external noreferrer">Azure Blob Storage</a>, not in configuration files or environment variables. <strong>Key Encryption</strong> means the master key in Azure Key Vault encrypts data protection keys—a proper key hierarchy. <strong>Key Rotation</strong> through the 90-day lifetime triggers automatic key generation while maintaining backward compatibility. <strong>Application Isolation</strong> via the application name scopes keys to the specific application, preventing cross-application key reuse.</p><h3 id="encrypting-database-columns-with-entity-framework"><a href="/posts/cryptography-dotnet-data-protection/#encrypting-database-columns-with-entity-framework" title="Encrypting Database Columns with Entity Framework">Encrypting Database Columns with Entity Framework</a></h3><p>To protect sensitive data at the persistence layer, integrate Data Protection with Entity Framework using purpose-limited encryption contexts:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">CustomerDataProtector</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">IDataProtector</span> <span class="n">_protector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CustomerDataProtector</span><span class="p">(</span><span class="n">IDataProtectionProvider</span> <span class="n">provider</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Purpose string limits scope—credit cards can&#39;t be decrypted with user profile protector</span>
</span></span><span class="line"><span class="cl">        <span class="n">_protector</span> <span class="p">=</span> <span class="n">provider</span><span class="p">.</span><span class="n">CreateProtector</span><span class="p">(</span><span class="s">&#34;CustomerModule.CreditCards&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">string</span> <span class="n">Protect</span><span class="p">(</span><span class="kt">string</span> <span class="n">plainText</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">plainText</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">plainText</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_protector</span><span class="p">.</span><span class="n">Protect</span><span class="p">(</span><span class="n">plainText</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">string</span> <span class="n">Unprotect</span><span class="p">(</span><span class="kt">string</span> <span class="n">cipherText</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">cipherText</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">cipherText</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="k">try</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">_protector</span><span class="p">.</span><span class="n">Unprotect</span><span class="p">(</span><span class="n">cipherText</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span> <span class="p">(</span><span class="n">CryptographicException</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Key rotation or corruption—handle gracefully</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s">&#34;[Decryption Failed]&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Entity Framework model with encrypted properties</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Customer</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Encrypted storage</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">string</span> <span class="n">EncryptedCreditCardNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="kd">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">    
</span></span></span><span class="line"><span class="cl"><span class="na">    [NotMapped]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">string</span> <span class="n">CreditCardNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">ProtectSensitiveData</span><span class="p">(</span><span class="n">CustomerDataProtector</span> <span class="n">protector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">CreditCardNumber</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">EncryptedCreditCardNumber</span> <span class="p">=</span> <span class="n">protector</span><span class="p">.</span><span class="n">Protect</span><span class="p">(</span><span class="n">CreditCardNumber</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">CreditCardNumber</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// Clear from memory</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">UnprotectSensitiveData</span><span class="p">(</span><span class="n">CustomerDataProtector</span> <span class="n">protector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">EncryptedCreditCardNumber</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">CreditCardNumber</span> <span class="p">=</span> <span class="n">protector</span><span class="p">.</span><span class="n">Unprotect</span><span class="p">(</span><span class="n">EncryptedCreditCardNumber</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Repository implementation</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">CustomerRepository</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">ApplicationDbContext</span> <span class="n">_context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">CustomerDataProtector</span> <span class="n">_protector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CustomerRepository</span><span class="p">(</span><span class="n">ApplicationDbContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">CustomerDataProtector</span> <span class="n">protector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_protector</span> <span class="p">=</span> <span class="n">protector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;</span> <span class="n">GetByIdAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">customer</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">Customers</span><span class="p">.</span><span class="n">FindAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">customer</span><span class="p">?.</span><span class="n">UnprotectSensitiveData</span><span class="p">(</span><span class="n">_protector</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">customer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">async</span> <span class="n">Task</span> <span class="n">SaveAsync</span><span class="p">(</span><span class="n">Customer</span> <span class="n">customer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">customer</span><span class="p">.</span><span class="n">ProtectSensitiveData</span><span class="p">(</span><span class="n">_protector</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_context</span><span class="p">.</span><span class="n">Customers</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">customer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">SaveChangesAsync</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <strong>purpose string</strong> (<code>"CustomerModule.CreditCards"</code>) creates a cryptographic boundary. Data encrypted with this protector cannot be decrypted by a protector created with a different purpose, even within the same application. This implements the <strong>principle of least privilege</strong>—code handling user authentication tokens cannot access credit card encryption keys.</p><h3 id="cookie-encryption-for-authentication-tokens"><a href="/posts/cryptography-dotnet-data-protection/#cookie-encryption-for-authentication-tokens" title="Cookie Encryption for Authentication Tokens">Cookie Encryption for Authentication Tokens</a></h3><p>ASP.NET Core&rsquo;s authentication middleware integrates Data Protection automatically for cookie-based authentication, but explicit configuration ensures compliance:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddAuthentication</span><span class="p">(</span><span class="n">CookieAuthenticationDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">AddCookie</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;CustomerPortal.Auth&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">HttpOnly</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">SecurePolicy</span> <span class="p">=</span> <span class="n">CookieSecurePolicy</span><span class="p">.</span><span class="n">Always</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">.</span><span class="n">Cookie</span><span class="p">.</span><span class="n">SameSite</span> <span class="p">=</span> <span class="n">SameSiteMode</span><span class="p">.</span><span class="n">Strict</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">.</span><span class="n">ExpireTimeSpan</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromHours</span><span class="p">(</span><span class="m">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">.</span><span class="n">SlidingExpiration</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Data Protection handles encryption transparently</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">.</span><span class="n">DataProtectionProvider</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Services</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">BuildServiceProvider</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IDataProtectionProvider</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span></code></pre></div><p>Authentication cookies are automatically encrypted using the configured Data Protection system. This prevents <strong>session hijacking</strong>, <strong>replay attacks</strong>, and <strong>tampering</strong>—security controls directly mapped to ISO 27001:2022 requirements for access control (A.5.15) and cryptographic protection (A.8.24).</p><h3 id="password-hashing-with-argon2"><a href="/posts/cryptography-dotnet-data-protection/#password-hashing-with-argon2" title="Password Hashing with Argon2">Password Hashing with Argon2</a></h3><p>Password storage requires computationally expensive hashing algorithms resistant to brute-force attacks. While Data Protection handles data encryption, password verification needs specialized algorithms like <a href="https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#argon2id" target="_blank" rel="noopener external noreferrer">Argon2id</a>—the current <a href="https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html" target="_blank" rel="noopener external noreferrer">OWASP recommendation</a>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">Konscious.Security.Cryptography</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">PasswordHasher</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">const</span> <span class="kt">int</span> <span class="n">SaltSize</span> <span class="p">=</span> <span class="m">16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">const</span> <span class="kt">int</span> <span class="n">HashSize</span> <span class="p">=</span> <span class="m">32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">const</span> <span class="kt">int</span> <span class="n">MemorySize</span> <span class="p">=</span> <span class="m">1024</span> <span class="p">*</span> <span class="m">128</span><span class="p">;</span> <span class="c1">// 128 MB</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">HashPassword</span><span class="p">(</span><span class="kt">string</span> <span class="n">password</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">salt</span> <span class="p">=</span> <span class="n">RandomNumberGenerator</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">SaltSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">hash</span> <span class="p">=</span> <span class="n">ComputeHash</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">SaltSize</span> <span class="p">+</span> <span class="n">HashSize</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">Buffer</span><span class="p">.</span><span class="n">BlockCopy</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">SaltSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Buffer</span><span class="p">.</span><span class="n">BlockCopy</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">SaltSize</span><span class="p">,</span> <span class="n">HashSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ToBase64String</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">bool</span> <span class="n">VerifyPassword</span><span class="p">(</span><span class="kt">string</span> <span class="n">password</span><span class="p">,</span> <span class="kt">string</span> <span class="n">hashedPassword</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">hashBytes</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">FromBase64String</span><span class="p">(</span><span class="n">hashedPassword</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">salt</span> <span class="p">=</span> <span class="n">hashBytes</span><span class="p">[..</span><span class="n">SaltSize</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">storedHash</span> <span class="p">=</span> <span class="n">hashBytes</span><span class="p">[</span><span class="n">SaltSize</span><span class="p">..];</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">computedHash</span> <span class="p">=</span> <span class="n">ComputeHash</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">CryptographicOperations</span><span class="p">.</span><span class="n">FixedTimeEquals</span><span class="p">(</span><span class="n">storedHash</span><span class="p">,</span> <span class="n">computedHash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">ComputeHash</span><span class="p">(</span><span class="kt">string</span> <span class="n">password</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">salt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">using</span> <span class="nn">var</span> <span class="n">argon2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Argon2id</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Salt</span> <span class="p">=</span> <span class="n">salt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">DegreeOfParallelism</span> <span class="p">=</span> <span class="m">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">MemorySize</span> <span class="p">=</span> <span class="n">MemorySize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Iterations</span> <span class="p">=</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">argon2</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">HashSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Argon2id combines the memory-hardness of Argon2i with the GPU-resistance of Argon2d. The algorithm&rsquo;s computational cost (128 MB memory, 4 iterations) makes brute-force attacks economically infeasible while remaining acceptable for single authentication attempts. The <a href="https://www.nuget.org/packages/Konscious.Security.Cryptography.Argon2" target="_blank" rel="noopener external noreferrer">Konscious.Security.Cryptography</a> NuGet package provides a solid implementation.</p><h2 id="key-lifecycle-management"><a href="/posts/cryptography-dotnet-data-protection/#key-lifecycle-management" title="Key Lifecycle Management">Key Lifecycle Management</a></h2><p>Proper key management requires documented procedures for generation, storage, distribution, rotation, and destruction. The <a href="https://learn.microsoft.com/aspnet/core/security/data-protection/implementation/key-management" target="_blank" rel="noopener external noreferrer">Data Protection API handles rotation automatically</a>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddDataProtection</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">SetDefaultKeyLifetime</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromDays</span><span class="p">(</span><span class="m">90</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">AddKeyManagementOptions</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">.</span><span class="n">AutoGenerateKeys</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="p">.</span><span class="n">NewKeyLifetime</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromDays</span><span class="p">(</span><span class="m">90</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span></code></pre></div><p>When a key expires, the system generates a new key for all new encryption operations. Existing data encrypted with old keys remains decryptable because the key ring maintains historical keys. For manual rotation—say, after a security incident—use <code>IKeyManager.CreateNewKey()</code> with immediate activation.</p><h2 id="validating-encryption-with-github-actions"><a href="/posts/cryptography-dotnet-data-protection/#validating-encryption-with-github-actions" title="Validating Encryption with GitHub Actions">Validating Encryption with GitHub Actions</a></h2><p>Automated scanning ensures sensitive data never reaches the repository unencrypted. Use <a href="https://github.com/trufflesecurity/trufflehog" target="_blank" rel="noopener external noreferrer">TruffleHog</a> for continuous compliance verification:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Security Scan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">main]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secrets-scan</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">fetch-depth</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Scan for exposed secrets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">trufflesecurity/trufflehog@main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">base</span><span class="p">:</span><span class="w"> </span><span class="l">${{ github.event.pull_request.base.sha }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">head</span><span class="p">:</span><span class="w"> </span><span class="l">${{ github.event.pull_request.head.sha }}</span><span class="w">
</span></span></span></code></pre></div><p>This blocks merges containing hardcoded credentials or embedded encryption keys—enforceable controls that prevent non-compliant code from reaching production.</p><h2 id="compliance-mapping"><a href="/posts/cryptography-dotnet-data-protection/#compliance-mapping" title="Compliance Mapping">Compliance Mapping</a></h2><p>The .NET Data Protection implementation satisfies multiple compliance requirements across frameworks:</p><table><thead><tr><th>Requirement</th><th>Implementation</th></tr></thead><tbody><tr><td><strong>Cryptographic Policy</strong></td><td>Documented configuration: AES-256-CBC, 256-bit keys, purpose strings for scope isolation</td></tr><tr><td><strong>Key Management</strong></td><td>Azure Key Vault with HSM-backed storage, access logging, 90-day rotation</td></tr><tr><td><strong>Key Hierarchy</strong></td><td>Master key encrypts data protection keys—defense in depth</td></tr><tr><td><strong>Cloud Controls</strong></td><td>Managed identities eliminate credential storage; encryption at rest for keys and data</td></tr></tbody></table><p>Whether you&rsquo;re auditing against ISO 27001, SOC 2, or GDPR Article 32, the implementation pattern remains identical. The framework handles the cryptographic heavy lifting—your job is configuration and integration.</p><h2 id="the-bottom-line"><a href="/posts/cryptography-dotnet-data-protection/#the-bottom-line" title="The Bottom Line">The Bottom Line</a></h2><p>Compliance standards exist because organizations repeatedly failed to protect sensitive data through ad-hoc security measures. Cryptographic controls codify lessons from decades of breaches: <strong>cryptography is complex, key management is critical, and professional implementations outperform clever hacks</strong>.</p><p>The .NET Data Protection API provides a compliance-ready framework—algorithm selection, key rotation, secure storage—all handled by Microsoft&rsquo;s cryptography team. The only requirement is resisting the temptation to reimplement what they spent years perfecting.</p><p>Use the Data Protection API. Integrate Azure Key Vault. Rotate your keys. Hash passwords with Argon2. <strong>These aren&rsquo;t best practices—they&rsquo;re minimum requirements</strong> for systems claiming to protect user data. The alternative is discovering during an audit that your XOR encryption was never encryption at all.</p></section><section class="giscus"><h2>Comments</h2><aside class="giscus" id="giscus-thread" role="region" aria-label="Comments"></aside></section><script src="https://giscus.app/client.js" data-repo="dailydevops/dailydevops.github.io" data-repo-id="R_kgDOHA8eFg" data-category="Announcements" data-category-id="DIC_kwDOHA8eFs4COIqL" data-mapping="pathname" data-strict="1" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous" async></script></article><aside class="sidebar divider"><section class="sidecar info" aria-labelledby="info-heading"><header><h2 id="info-heading" class="sr-only">Informations</h2></header><ul role="list"><li role="listitem"><time datetime="2026-02-05T17:00:00+01:00" itemprop="datePublished">Published on 2/5/26 5:00 pm</time></li><li>Read in 8 minutes</li></ul></section><section class="sidecar series" aria-labelledby="series-heading"><header><h2 id="series-heading">Series content</h2></header><nav class="series-nav" role="navigation" aria-label="Series content"><ul role="list"><li role="listitem"><a href="https://daily-devops.net/posts/secrets-management-azure-keyvault/" title="Your appsettings.json Is a Compliance Violation" target="_blank" rel="noopener external noreferrer"><i class="fas fa-angles-right" aria-hidden="true"></i>&nbsp;
Your appsettings.json Is a Compliance Violation</a></li><li role="listitem"><a href="https://daily-devops.net/posts/cryptography-dotnet-data-protection/" title="Your Encryption Is Broken — .NET Data Protection Done Right" target="_blank" rel="noopener external noreferrer"><i class="fas fa-angles-right" aria-hidden="true"></i>&nbsp;
Your Encryption Is Broken — .NET Data Protection Done Right</a></li></ul></nav></section><section class="sidecar author" aria-labelledby="author-martin-st%C3%BChmer"><header><h2 id="author-martin-st%C3%BChmer"><a href="/authors/martin/" rel="author" title="Martin Stühmer" itemprop="url">Author <span itemprop="name">Martin Stühmer</span></a></h2></header><figure class="round"><picture><img src="https://www.gravatar.com/avatar/6da4a47ff9cc2b750452225fdb2582f7?d=identicon&amp;s=200" alt="Martin Stühmer" loading="lazy" decoding="async" title="Martin Stühmer"></picture></figure><section class="content" itemprop="description">CTO at Integrated Worlds building cloud-native solutions on Azure with modern .NET. Nearly 20 years in .NET from Framework 2.0 to today. Microsoft Certified Trainer, former CGI Director, open-source maintainer. I’ve made every mistake, bet on dead technologies, and learned more from failures than successes. Quality isn’t optional, buzzwords don’t ship features, and experience means knowing what to avoid.</section><a class="link" href="/authors/martin/" rel="author" aria-label="Author Martin Stühmer: Read more"></a></section><section class="sidecar social" aria-labelledby="social-heading"><header><h2 id="social-heading">Social media</h2></header><nav class="social-nav" role="navigation" aria-label="Social media links"><a class="icon bluesky" href="https://bsky.app/profile/samtrion.net" rel="noopener external" aria-label="Follow me on Bluesky" target="_blank"><span class="fa-stack fa-fw fa-1x" aria-hidden="true"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-bluesky fa-stack-1x fa-inverse"></i>
</span></a><a class="icon github" href="https://github.com/samtrion" rel="noopener external" aria-label="Follow me on GitHub" target="_blank"><i class="fa-brands fa-fw fa-github fa-2x" aria-hidden="true"></i></a>
<a class="icon linkedin" href="https://www.linkedin.com/in/martin-stuehmer" rel="noopener external" aria-label="Follow me on LinkedIn" target="_blank"><span class="fa-stack fa-fw fa-1x" aria-hidden="true"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin-in fa-stack-1x fa-inverse"></i>
</span></a><a class="icon stackoverflow" href="https://stackoverflow.com/users/10574963" rel="noopener external" aria-label="Follow me on Stack Overflow" target="_blank"><span class="fa-stack fa-fw fa-1x" aria-hidden="true"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
</span></a><a class="icon mail" href="mailto:martin@daily-devops.net" aria-label="Contact me by e-mail" target="_blank"><span class="fa-stack fa-fw fa-1x" aria-hidden="true"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
</span></a><a class="icon feed" href="/authors/martin/feed.rss" aria-label="My RSS feed" target="_blank"><span class="fa-stack fa-fw fa-1x" aria-hidden="true"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></nav></section><section class="sidecar share" aria-labelledby="share-heading"><header><h2 id="share-heading">Share this content</h2></header><a class="icon linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fdaily-devops.net%2fposts%2fcryptography-dotnet-data-protection%2f&text=Your%20Encryption%20Is%20Broken%20%e2%80%94%20.NET%20Data%20Protection%20Done%20Right%20%26mdash%3b%20Daily%20DevOps%20%26%20.NET" target="_blank" rel="noopener external" aria-label="Share on LinkedIn" title="Share on LinkedIn" target="_blank"><i class="fa-brands fa-fw fa-linkedin-in fa-2x"></i></a>
<a class="icon bluesky" href="https://bsky.app/intent/compose?text=Your%20Encryption%20Is%20Broken%20%e2%80%94%20.NET%20Data%20Protection%20Done%20Right%20%26mdash%3b%20Daily%20DevOps%20%26%20.NET%20https%3a%2f%2fdaily-devops.net%2fposts%2fcryptography-dotnet-data-protection%2f" target="_blank" rel="noopener external" aria-label="Share on Bluesky" title="Share on Bluesky" target="_blank"><i class="fa-brands fa-fw fa-bluesky fa-2x"></i></a></section><section class="sidecar tags" aria-labelledby="tags-heading"><header><h2 id="tags-heading">Tags</h2></header><ul class="tags" role="list"><li class="tag" role="listitem"><a href="/tags/dotnet/" hreflang="en" rel="tag" title=".NET" aria-label=".NET tag"><i class="fas fa-tag" aria-hidden="true"></i>&nbsp;.NET</a></li><li class="tag" role="listitem"><a href="/tags/iso-standards/" hreflang="en" rel="tag" title="ISO Standards" aria-label="ISO Standards tag"><i class="fas fa-tag" aria-hidden="true"></i>&nbsp;ISO Standards</a></li><li class="tag" role="listitem"><a href="/tags/security/" hreflang="en" rel="tag" title="Security" aria-label="Security tag"><i class="fas fa-tag" aria-hidden="true"></i>&nbsp;Security</a></li></ul></section><section class="sidecar related" aria-labelledby="related-heading"><header><h2 id="related-heading">Related content</h2></header><article class="post"><figure class="square"><picture><source srcset="/images/security-80x80.webp?v=35f82cde59317b992b40db6eee90c415" type="image/webp"><source srcset="/images/security-80x80.png?v=6b7b9203a90fa2d6df665509ee32b1e2" type="image/png"><img src="/images/security.png?v=530c4f0b5995d08df3450423fd03c5e0" alt="Your appsettings.json Is a Compliance Violation" loading="lazy" decoding="async" title="Your appsettings.json Is a Compliance Violation"></picture></figure><header><h2><a href="/posts/secrets-management-azure-keyvault/" rel="bookmark">Your appsettings.json Is a Compliance Violation</a></h2></header><section class="content" role="region">Hardcoded secrets aren&rsquo;t just bad practice—they&rsquo;re ISO 27017 violations with real consequences: failed audits, denied insurance claims, contractual penalties. That connection string in your appsettings.Production.json? It represents a compliance gap your organization probably doesn&rsquo;t even know exists. Azure Key Vault with Managed Identity isn&rsquo;t an optional security enhancement—it&rsquo;s the minimum viable implementation of standards you already claim to follow.</section></article><article class="post"><figure class="square"><picture><source srcset="/images/observability-80x80.webp?v=e029eb3d74e4d67f04990ad14af8ed68" type="image/webp"><source srcset="/images/observability-80x80.png?v=53f54ab518d5253040a9c4eff2a6b8ff" type="image/png"><img src="/images/observability.png?v=48acbd668436dc9dd3287b4ec5564639" alt="Audit Logging That Survives Your Next Security Incident" loading="lazy" decoding="async" title="Audit Logging That Survives Your Next Security Incident"></picture></figure><header><h2><a href="/posts/audit-logging-azure-app-insights/" rel="bookmark">Audit Logging That Survives Your Next Security Incident</a></h2></header><section class="content" role="region">Your audit logs probably won&rsquo;t survive a real security incident. Most implementations log too much, protect too little, and provide zero value when something breaks at 2 AM. Here&rsquo;s how to fix that with structured logging that actually works.</section></article><article class="post"><figure class="square"><picture><source srcset="/images/security-80x80.webp?v=35f82cde59317b992b40db6eee90c415" type="image/webp"><source srcset="/images/security-80x80.png?v=6b7b9203a90fa2d6df665509ee32b1e2" type="image/png"><img src="/images/security.png?v=530c4f0b5995d08df3450423fd03c5e0" alt="Your [Authorize] Attribute Is Compliance Theater
" loading="lazy" decoding="async" title="Your [Authorize] Attribute Is Compliance Theater
"></picture></figure><header><h2><a href="/posts/access-control-aspnet-core/" rel="bookmark">Your [Authorize] Attribute Is Compliance Theater</a></h2></header><section class="content" role="region"><p><strong>Your <code>[Authorize]</code> attributes give you a false sense of security. ISO 27001 auditors see right through it.</strong></p><p>I&rsquo;ve reviewed dozens of ASP.NET Core apps that authenticate flawlessly — then scatter role strings across business logic, skip audit logs, and wonder why they fail compliance. Here&rsquo;s the pattern that kills audits, and how to actually fix it.</p></section></article></section></aside><nav class="pager" aria-label="Article navigation" role="navigation"><a class="prev" href="/posts/storage-architecture-stateful-workloads-aks/" rel="prev" aria-label="Previous: Storage Architecture & Stateful Workloads in AKS"><span class="sub"><span class="sr-only">Previous</span>&emsp;<i class="fas fa-forward" aria-hidden="true"></i></span><p class="title">Storage Architecture & Stateful Workloads in AKS</p></a></nav></main><footer class="footer"><div class="divider"></div><nav><ul class="navigation"><li><a href="/tags/">Tags</a></li><li><a href="/legal-notice/">Legal notice</a></li></ul></nav><div class="copyright">&copy; 2023 - 2026 Daily DevOps & .NET</div></footer><script defer src="/js/below.min.a6ce9164454b6077f17ae856f280442d9f3a1e21f06189f71c21f75144b22a0c8cf32bafd61d440e9d90ca02bf738b6a8ef19f5ec20285d8ca574f98c91ebaf2.js" integrity="sha512-ps6RZEVLYHfxeuhW8oBELZ86HiHwYYn3HCH3UUSyKgyM8yuv1h1EDp2QygK/c4tqjvGfXsIChdjKV0+YyR668g==" crossorigin="anonymous"></script><img class="vgwort" src="https://vg05.met.vgwort.de/na/6902c44fef134fcd9da874e21f1cd8a9" width="1" height="1" alt="VG Wort" title="VG Wort"></body></html>